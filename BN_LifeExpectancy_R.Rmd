---
title: "Bayesan Networks and Causal Inference - First Assignment"
output: 
 html_document:
    toc: true
    toc_depth: 2
    theme: paper
    highlight: default

#runtime: shiny
---
<style type="text/css">
body{
  text-align: justify;
  font-size: 13pt;
}

code.r{
  font-size: 15px;
}
pre {
  font-size: 15px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Introduction

We are going to use a dataset that reports life expectancy values for 193 different countries from 2000 to 2015. The dataset contains immunization factors, mortality factors, economical factors and social factors considered important to influence life expectancy. The data is obtained from the Global Health Observatory (GHO) data repository under World Health Organization (WHO). The dataset is available at the link [https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who]. <br>
We want to test the performance of Bayesian classifiers for predicting life expectancy and study the conditional dependencies between the considered variables.<br>


## Variable selection

The dataset contains 22 variables, 3 categorical ones and 19 continuous ones. For this project we select 9 variables, including life expectancy.<br> 
Considering missing values, information content and possible dependencies we decide to keep the following variables:<br>
- *Life expectancy*: life expectancy value in age;<br>
- **Adult mortality**: probability that those who have reached age 15 will die before reaching age 60, shown per 1000 persons;<br>
- Alcohol: litres of pure alcohol consumed per capita between people more than 15 years old;<br>
- BMI: average Body Mass Index of the entire population;<br>
- under-five deaths: number of under-five deaths per 1000 inhabitants;<br>
- Polio: Polio (Pol3) immunization coverage percentage among 1-year-olds;<br>
- Diphtheria: Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage percentageamong 1-year-olds;<br>
- Total expenditure: government expenditure on health as a percentage of total government expenditure;<br>
- Income composition of resources: Human Development Index in terms of income composition of resources, ranging from 0 to 1.<br>

## Packages and libraries

We import the packages and libraries we are going to use.
```{r cars}
#install.packages("visdat")
#install.packages("dlookr")
#install.packages("dagitty")
#install.packages("ggplot")
#install.packages("dplyr")
#install.packages("ggcorrplot")
library(ggcorrplot)
library(dagitty)
library(dplyr)
library(dlookr)
library(ggplot2)
library(visdat)
```

## Exploratory analysis

We load the dataset.
```{r}
lexp <- read.csv('Life Expectancy Data.csv', header = TRUE, stringsAsFactors = TRUE)
str(lexp)
#lexp2 <- lexp
```

We drop the varaiables we are not interested in. We change the names to more practical ones.
```{r}
vars <- c("Life.expectancy", "Adult.Mortality", "Alcohol", "BMI", "under.five.deaths", "Polio", "Diphtheria", "Total.expenditure", "Income.composition.of.resources")
#vars <- c("Life.expectancy", "Adult.Mortality", "Alcohol", "Polio", "Total.expenditure", "Income.composition.of.resources", "GDP","thinness..1.19.years", "Schooling")
lexp2 <- lexp[vars]
colnames(lexp2) <- c("Lexp", "AdultMort.", "Alcohol", "BMI", "under5deaths", "Polio", "Diphth.", "HealthExp.","ICR")
#colnames(lexp2) <- c("Lexp", "AdultMort.", "Alcohol", "Polio", "HealthExp.","ICR", "GDP", "Thin.", "School.")
```

We check if the values have been uploaded correctly.
```{r}
str(lexp2)
```

The values are all of the type expected. We have 9 variables and 2938 observations. We perform a summary analysis of the variables.
```{r}
summary(lexp2)
```

The variable under5deaths clearly present a problem. It should be a ratio per 1000 inhabitants but the max value is 2500. We analyse this problem.
```{r}
probl <- subset(lexp2, under5deaths >= 1000)
print(summary(probl))
print(nrow(probl))
```

The rows with a value of under5deaths greater than 1000 are 16. The other variables of these rows have normal values. Probably they refer to the same country. We check this in the original dataset.
```{r}
probl2 <- subset(lexp, under.five.deaths >= 1000)
print(probl2)
```

The considered rows all refer to India. We manually search for the values of under5deaths for India and we insert them. Data is obtained from [https://data.unicef.org/country/ind/].
```{r}
ind <- c(1187:1202)
j=1
vals <- c(91.7, 88.1, 84.5, 81.1, 77.8, 74.4, 71.1, 67.9, 64.6, 61.4, 58.2, 55, 52, 49, 46.2, 43.5)
for (i in ind){
  lexp2[i, 'under5deaths'] <- vals[j]
  j=j+1
}
summary(lexp2)
```

The variable under5deaths still present strange values, higher than 900. The values refer to Nigeria. We manually check the values and we realise that are not correct. We still decide to keep this variable for now. We will decide what to do after missing values and outliers analysis.
 
### Missing values
We analyse the missing values.
```{r,  fig.align="center", fig.width = 6, fig.height=6}
My_theme2 <- function() {
   theme(axis.title=element_text(size=10), axis.text=element_text(size=10),
         legend.title = element_text(size=10), legend.text = element_text(size=10))
}
lexp2 <- subset(lexp2, select=-c(BMI))
vis_miss(lexp2)+ My_theme2()
diagnose(lexp2)
```

We have percentages of missing values higher than 5% just for Alcohol, HealthExp. and ICR. For IncComp we have 5 black areas. The missing values are probably concentrated in a few countries since in the original dataset observations were grouped by countries. For Alcohol and HealthExp. missing values are more spread through countries. Most of the rows with missing values are in common between the two countries. The total completness of the dataset is 97.4%. We calculate the percentage of rows with no NA values in the dataframe.
```{r}
print(nrow(na.omit(lexp2)) / nrow(lexp2))
```

We have a ratio of 0.87 complete rows. We consider it an acceptable value so we decide to just remove the rows with missing values.
```{r}

lexp3 <- na.omit(lexp2)
str(lexp3)
```

### Outliers
We analyse now the outliers for each variable.
```{r}
diagnose_outlier(lexp3)
```
```{r}
plot_outlier(lexp3)
```

The variables where the outliers seem to be more influent are AdultMort., under5deaths, Dhipth. and Polio. Polio and Dhipth. have most of the values close to 1, the 1st quartile is 78. So the presence of just a few lower outliers strongly influence the distribution. We do not consider necessary to handle these outliers, since the data probably reflects the reality. We already highlighted before that some of the observations of the variable under5deaths are not correct. We remove the outliers for this variable to try to solve the situation. We remove the outliers also for AdultMort.. It has a low ratio of outliers but they are very influent as we can see from the difference between the mean with outliers and the mean without.
```{r}
Q1_am <- quantile(lexp3$AdultMort., .25)
Q3_am <- quantile(lexp3$AdultMort., .75)
IQR_am <- IQR(lexp3$AdultMort.)

Q1_5d <- quantile(lexp3$under5deaths, .25)
Q3_5d <- quantile(lexp3$under5deaths, .75)
IQR_5d <- IQR(lexp3$under5deaths)

lexp4 <- subset(lexp3, lexp3$AdultMort. > (Q1_am - 1.5*IQR_am) & lexp3$AdultMort. < (Q3_am + 1.5*IQR_am))
lexp5 <- subset(lexp4, lexp4$under5deaths > (Q1_5d - 1.5*IQR_5d) & lexp4$under5deaths < (Q3_5d + 1.5*IQR_5d))

summary(lexp5)
str(lexp5)
```
The values now make sense. We have 2142 observations, a 73% of the 2938 of the original dataset.

### Variable distribution
We analyse now variables distribution.
```{r fig1, fig.height = 6, fig.width = 6}
My_theme_2 <- function() {
   theme(axis.title=element_text(size=8), axis.text=element_text(size=8))
}
p1 <- ggplot(lexp5, aes(x=Lexp)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p2 <- ggplot(lexp5, aes(x=AdultMort.)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p3 <- ggplot(lexp5, aes(x=Alcohol)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
#p4 <- ggplot(lexp5, aes(x=BMI)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p5 <- ggplot(lexp5, aes(x=under5deaths)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p6 <- ggplot(lexp5, aes(x=Polio)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p7 <- ggplot(lexp5, aes(x=Diphth.)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p8 <- ggplot(lexp5, aes(x=HealthExp.)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
p9 <- ggplot(lexp5, aes(x=ICR)) + geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + My_theme_2()
gridExtra::grid.arrange(p1, p2, p3, p5, p6, p7, p8, p9, ncol=3)
```

ICR is the variable with the most similar distribution to Life Expectancy. AdultMort. and Alcohol are both rigth-skewed. Polio and Diphth. have almost identical distributions, both strongly left-skewed, indicating that probably most of the time these vaccines are taken together. HealthExp. seems the most symmetric one. AdultMort., BMI and ICR are the most clearly multimodal distributions, indicating multiple points of concentration of observations.<br>
We analyse now the correlations between the variables.
```{r}
#m <- cor(lexp5)
m <- cor(lexp)
ggcorrplot(m,  hc.order = FALSE, type = 'upper', lab = TRUE)
```

The most positive correlated variables with Lexp are ICR and BMI. AdultMort. and under5deaths are obviously negatively correlated with Lexp. The higher the number of deaths is, the lower the life expectancy is. Among the other variables Polio and Dhiptheria are positively correlated, as expected.

## Network
We can now start building our network.
```{r fig2, fig.height = 10, fig.width = 10}
g <- dagitty('dag {
AdultMort. [pos="-1.651,-0.974"]
Alcohol [pos="-0.519,-1.382"]
HealthExp. [pos="-1.705,0.063"]
ICR [pos="-0.499,-0.619"]
Lexp [outcome,pos="-0.434,1.424"]
Polio [pos="0.632,-0.947"]
under5deaths [pos="0.640,0.177"]
AdultMort. -> Lexp
Alcohol -> AdultMort.
HealthExp. -> Lexp
ICR -> AdultMort.
ICR -> HealthExp.
ICR -> Polio
Polio -> under5deaths
under5deaths -> Lexp
}

')

plot(g)
```
We are now going to test our network.
```{r}
impliedConditionalIndependencies(g)
```
We are now going to test our network.
```{r}
localTests(g, lexp5)
```
second network
we decide to put some more dependencies to correct the results
```{r}
g2 <- dagitty('dag {
AdultMort. [pos="-1.651,-0.974"]
Alcohol [pos="-0.359,-1.475"]
HealthExp. [pos="-1.579,0.489"]
ICR [pos="0.356,-1.158"]
Lexp [outcome,pos="-0.434,1.424"]
Polio [pos="0.632,-0.514"]
under5deaths [pos="0.632,0.451"]
AdultMort. -> Lexp
Alcohol -> AdultMort.
Alcohol -> Lexp
Alcohol <-> HealthExp.
Alcohol <-> ICR
HealthExp. -> Lexp
ICR -> AdultMort.
ICR -> HealthExp.
ICR -> Lexp
ICR -> Polio
Polio -> under5deaths
under5deaths -> Lexp
}
'
)

plot(g2)
```

```{r}
impliedConditionalIndependencies(g2)
```

test
```{r}
lt <- localTests(g2, lexp5)
lt
```

```{r}
plotLocalTestResults(lt, xlim=c(-1,1))
```
we still are in abÃ¬ bad situation
explicar porque quitamos under5deaths
bmi porque nos damos cuenta de que esta mal y under5 porque estaba mal al principio y seguramente no lo corregimos bien


```{r}
g3 <- dagitty('
dag {
AdultMort. [pos="-1.511,-0.952"]
Alcohol [pos="-0.562,-1.461"]
HealthExp. [pos="-1.495,-0.029"]
ICR [pos="0.559,-1.052"]
Lexp [outcome,pos="-0.518,0.581"]
Polio [pos="0.726,-0.313"]
AdultMort. -> Lexp
Alcohol -> Lexp
Alcohol <-> HealthExp.
Alcohol <-> ICR
HealthExp. -> Lexp
HealthExp. -> Polio
ICR -> AdultMort.
ICR -> HealthExp.
ICR -> Lexp
Polio -> Lexp
}


')

plot(g3)

lt <- localTests(g9, lexp4)

lt
```

icr polio
```{r}
g4 <- dagitty('
dag {
AdultMort. [pos="-1.511,-0.952"]
Alcohol [pos="-0.562,-1.461"]
HealthExp. [pos="-1.495,-0.029"]
ICR [pos="0.559,-1.052"]
Lexp [outcome,pos="-0.518,0.581"]
Polio [pos="0.726,-0.313"]
AdultMort. -> Lexp
Alcohol -> Lexp
Alcohol <-> HealthExp.
Alcohol <-> ICR
HealthExp. -> Lexp
HealthExp. -> Polio
ICR -> AdultMort.
ICR -> HealthExp.
ICR -> Lexp
ICR -> Polio
Polio -> Lexp
}

')

plot(g4)

lt <- localTests(g4, lexp4)

lt
```
icr to polio
llegamos a pocas independencies pero significativas
hablar de que icr ingloba muchas cosa y posiblmente por eso hay que condicionar siempre sobre icr


remove health to polio, put icr to polio
```{r}
g5 <- dagitty('
dag {
AdultMort. [pos="-1.511,-0.952"]
Alcohol [pos="-0.562,-1.461"]
HealthExp. [pos="-1.495,-0.029"]
ICR [pos="0.559,-1.052"]
Lexp [outcome,pos="-0.518,0.581"]
Polio [pos="0.726,-0.313"]
AdultMort. -> Lexp
Alcohol -> Lexp
Alcohol <-> HealthExp.
Alcohol <-> ICR
HealthExp. -> ICR
HealthExp. -> Lexp
ICR -> AdultMort.
ICR -> Lexp
ICR -> Polio
Polio -> Lexp
}

')

plot(g5)

lt <- localTests(g5, lexp4)

lt
```
tenemos una ind mas, perdemos la de 01 por una de 02 y una de 04, reflexionar si esto es bueno o es malo, tambien mirando si las independencies son interesantes

we decide to add unused variables from the original dataset instead of icr because of interpretability, ....
explain why we choose these variables
with new variables
explain also why we don't choose schooling for now

```{r}
g6 <- dagitty('
dag {
AdultMort. [pos="-1.333,-1.093"]
Alcohol [pos="-0.905,-1.356"]
GDP [pos="-0.186,-1.359"]
HealthExp. [pos="-1.439,-0.255"]
Lexp [outcome,pos="-0.495,0.491"]
Polio [pos="0.546,-0.322"]
Thin. [pos="0.444,-0.858"]
AdultMort. -> Lexp
Alcohol -> AdultMort.
Alcohol -> Lexp
Alcohol <-> HealthExp.
GDP -> AdultMort.
GDP -> Alcohol
GDP -> HealthExp.
GDP -> Lexp
GDP -> Polio
GDP -> Thin.
HealthExp. -> AdultMort.
HealthExp. -> Lexp
HealthExp. -> Polio
HealthExp. -> Thin.
Polio -> AdultMort.
Polio -> Lexp
Thin. -> Lexp
Thin. -> Polio
}


')



lt <- localTests(g6, lexp4)

lt
```
we now add schololing because the results are shit
intentar hacer otras prubeas pa ver si sin schooling ni icr scamos algo decente, sino simplemente decimos
que esto confirma lo que deciamos antes, que icr ingloba muchas mas variables y por eso condicionar sobre
icr ayuda mucho
schooling has the same problem of icr but it is a bit better
```{r}
g7 <- dagitty('
dag {
AdultMort. [pos="-1.324,-0.923"]
Alcohol [pos="-0.856,-1.386"]
GDP [pos="0.047,-1.414"]
HealthExp. [pos="-1.307,-0.033"]
Lexp [outcome,pos="-0.495,0.491"]
Polio [pos="0.516,-0.046"]
School. [pos="0.427,-1.205"]
Thin. [pos="0.524,-0.841"]
AdultMort. -> Lexp
Alcohol -> AdultMort.
Alcohol -> Lexp
Alcohol <-> HealthExp.
Alcohol <-> School.
GDP -> AdultMort.
GDP -> Alcohol
GDP -> HealthExp.
GDP -> Lexp
GDP -> Polio
GDP -> School.
GDP -> Thin.
HealthExp. -> AdultMort.
HealthExp. -> Lexp
HealthExp. -> Polio
HealthExp. -> Thin.
Polio -> AdultMort.
Polio -> Lexp
School. -> Lexp
Thin. -> Lexp
Thin. -> Polio
}
')

lt <- localTests(g7, lexp4)

lt
```

```{r}
g8 <- dagitty('
dag {
AdultMort. [pos="-1.324,-0.923"]
Alcohol [pos="-0.856,-1.386"]
GDP [pos="0.047,-1.414"]
HealthExp. [pos="-1.307,-0.033"]
Lexp [outcome,pos="-0.495,0.491"]
Polio [pos="0.516,-0.046"]
School. [pos="0.427,-1.205"]
Thin. [pos="0.524,-0.841"]
AdultMort. -> Lexp
Alcohol -> AdultMort.
Alcohol -> Lexp
Alcohol <-> HealthExp.
Alcohol <-> School.
GDP -> AdultMort.
GDP -> Alcohol
GDP -> HealthExp.
GDP -> Lexp
GDP -> Polio
GDP -> School.
GDP -> Thin.
HealthExp. -> AdultMort.
HealthExp. -> Lexp
HealthExp. -> Polio
HealthExp. -> Thin.
Polio -> AdultMort.
Polio -> Lexp
School. -> AdultMort.
School. -> Lexp
School. -> Polio
School. -> Thin.
Thin. -> Lexp
Thin. -> Polio
}

')

lt <- localTests(g8, lexp4)

lt
```
conclusion: same problem we had with icr, too many dependencies, but with worst results, the 4 independencies we get are not even significant


general conclusion: the variables are often correlated with third variables, for example a high schooling is characteristic of a developed country, a developed country will probably present a high level of polio vaccinated, that's why school is correlated to polio


